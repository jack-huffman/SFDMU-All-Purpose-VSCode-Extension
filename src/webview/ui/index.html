<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFDMU Migration</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <div class="header-bar">
        <h1 id="config-name-header" class="config-name-header-editable" contenteditable="true" title="Click to rename configuration">SFDMU Migration</h1>
        
        <!-- Org Selection in Header -->
        <div class="header-org-selection" id="header-org-selection" style="display: none;">
            <div class="header-org-item">
                <div class="org-label-with-action">
                    <label>Source Org</label>
                </div>
                <div class="org-select-wrapper">
                    <select id="source-org-select" class="org-select">
                        <option value="">Select org...</option>
                    </select>
                </div>
                <div class="org-manual" id="source-org-manual" style="display: none;">
                    <input type="text" id="source-org-username" placeholder="Username" class="text-input-small">
                    <input type="text" id="source-org-instance-url" placeholder="Instance URL" class="text-input-small">
                    <input type="password" id="source-org-access-token" placeholder="Access Token (optional)" class="text-input-small">
                </div>
            </div>
            
            <div class="org-arrow">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 16L12 10V22L20 16Z" fill="currentColor"/>
                </svg>
            </div>
            
            <div class="header-org-item">
                <div class="org-label-with-action">
                    <label>Target Org</label>
                    <button id="refresh-orgs" class="org-refresh-icon" title="Refresh Orgs">
                        <span class="codicon codicon-refresh"></span>
                    </button>
                </div>
                <div class="org-select-wrapper">
                    <select id="target-org-select" class="org-select">
                        <option value="">Select org...</option>
                    </select>
                </div>
                <div class="org-manual" id="target-org-manual" style="display: none;">
                    <input type="text" id="target-org-username" placeholder="Username" class="text-input-small">
                    <input type="text" id="target-org-instance-url" placeholder="Instance URL" class="text-input-small">
                    <input type="password" id="target-org-access-token" placeholder="Access Token (optional)" class="text-input-small">
                </div>
            </div>
        </div>
        
        <div class="header-actions" id="header-actions" style="display: none;">
            <div class="mode-badge" id="mode-badge" style="display: none;">
                <span class="mode-badge-label" id="mode-badge-label"></span>
            </div>
            <button id="save-config" class="btn-secondary btn-small" title="Save or update configuration">Save</button>
        </div>
    </div>
    
        <div class="main-container">
        <!-- File Explorer Sidebar -->
        <div class="explorer-sidebar">
            <div class="explorer-header">
                <h3>Configurations</h3>
                <button id="create-folder-btn" class="icon-button-small" title="Create Folder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder-plus" viewBox="0 0 16 16">
                        <path d="m.5 3 .04.87a2 2 0 0 0-.342 1.311l.637 7A2 2 0 0 0 2.826 14H9v-1H2.826a1 1 0 0 1-.995-.91l-.637-7A1 1 0 0 1 2.19 4h11.62a1 1 0 0 1 .996 1.09L14.54 8h1.005l.256-2.819A2 2 0 0 0 13.81 3H9.828a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 6.172 1H2.5a2 2 0 0 0-2 2m5.672-1a1 1 0 0 1 .707.293L7.586 3H2.19q-.362.002-.683.12L1.5 2.98a1 1 0 0 1 1-.98z"/>
                        <path d="M13.5 9a.5.5 0 0 1 .5.5V11h1.5a.5.5 0 1 1 0 1H14v1.5a.5.5 0 1 1-1 0V12h-1.5a.5.5 0 0 1 0-1H13V9.5a.5.5 0 0 1 .5-.5"/>
                    </svg>
                </button>
            </div>
            <div class="explorer-tree" id="explorer-tree">
                <div class="explorer-loading">Loading...</div>
            </div>
            <div class="explorer-footer">
                <button id="add-config-btn" class="btn-secondary explorer-add-config-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-file-earmark-plus" viewBox="0 0 16 16">
                        <path d="M8 6.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V9.5H6a.5.5 0 0 1 0-1h1.5V7a.5.5 0 0 1 .5-.5"/>
                        <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5z"/>
                    </svg>
                    <span>Add Configuration</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content" id="main-content" style="display: none;">
            <!-- Migration Objects Panel -->
            <div class="migration-objects-panel">
                <div class="migration-objects-header">
                    <h2 id="migration-objects-title">Migration Objects</h2>
                    <div class="migration-objects-header-right">
                        <div class="dml-operation-control">
                            <label>DML Operation</label>
                            <select id="dml-operation" class="select-input">
                                <option value="Upsert" selected>Upsert</option>
                                <option value="Insert">Insert</option>
                                <option value="Update">Update</option>
                                <option value="Delete">Delete</option>
                                <option value="DeleteHierarchy">DeleteHierarchy</option>
                                <option value="DeleteSource">DeleteSource</option>
                            </select>
                        </div>
                        <div class="config-button-wrapper">
                            <button id="migration-config-button" class="icon-button" title="Configuration">
                                <span class="codicon codicon-settings-gear"></span>
                            </button>
                        </div>
                        <div class="migration-action-buttons-wrapper">
                            <div class="migration-action-buttons">
                                <button id="generate-files-icon" class="icon-button" title="Generate Migration File">
                                    <span class="codicon codicon-file-add"></span>
                                </button>
                                <button id="export-excel-icon" class="icon-button standard-mode-only" title="Export to Excel">
                                    <span class="codicon codicon-table"></span>
                                </button>
                                <button id="simulate-migration-icon" class="icon-button standard-mode-only" title="Simulate Migration">
                                    <span class="codicon codicon-debug-alt"></span>
                                </button>
                                <button id="run-migration-icon" class="icon-button icon-button-primary standard-mode-only" title="Run Migration">
                                    <span class="codicon codicon-run"></span>
                                </button>
                                <button id="create-backup-icon" class="icon-button standard-mode-only" title="Create Backup">
                                    <span class="codicon codicon-cloud-download"></span>
                                </button>
                                <button id="rollback-migration-icon" class="icon-button icon-button-warning standard-mode-only" title="Rollback Migration" style="display: none;">
                                    <span class="codicon codicon-discard"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="migration-objects-header-actions">
                    <button id="add-object" class="btn-secondary objects-mode-only">
                        <span class="codicon codicon-add"></span>
                        <span>Add Object</span>
                    </button>
                </div>
                
                
                <!-- Migration Objects List -->
                <div class="migration-objects-content">
                    <!-- Standard Objects Mode -->
                    <div id="objects-mode-container">
                        <div id="migration-objects-list" class="migration-objects-list">
                            <p class="info-text">No objects added yet. Click "Add Object" to get started.</p>
                        </div>
                    </div>

                    <!-- CPQ Mode -->
                    <div id="cpq-mode-container" class="cpq-mode-container" style="display: none;">
                        <div id="cpq-run-phases-section" class="cpq-run-phases">
                            <!-- Phase Tabs Navigation -->
                            <div id="cpq-phase-tabs" class="cpq-phase-tabs">
                                <!-- Tabs will be dynamically generated -->
                            </div>
                            
                            <!-- Phase Tab Content -->
                            <div id="cpq-phase-content" class="cpq-phase-content">
                                <div id="cpq-individual-phases" class="individual-phases">
                                    <p class="info-text">
                                        Click "Generate" in the header to create CPQ phase files, then run phases from here.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RCA Mode -->
                    <div id="rca-mode-container" class="rca-mode-container" style="display: none;">
                        <!-- RCA Alpha disclaimer banner -->
                        <div id="rca-alpha-banner" class="rca-alpha-banner" role="status">
                            <span class="rca-alpha-banner-text">Alpha — In Progress</span>
                            <span class="rca-alpha-banner-subtext">RCA mode has not been fully tested and may contain bugs. Use with caution.</span>
                        </div>
                        <!-- RCA Phases Section -->
                        <div id="rca-run-phases-section" class="rca-run-phases">
                            <!-- Phase Tabs Navigation -->
                            <div id="rca-phase-tabs" class="rca-phase-tabs">
                                <!-- Tabs will be dynamically generated -->
                            </div>
                            
                            <!-- Phase Tab Content -->
                            <div id="rca-phase-content" class="rca-phase-content">
                                <div id="rca-individual-phases" class="individual-phases">
                                    <p class="info-text">
                                        Click "Generate" in the header to create RCA phase files, then run phases from here.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Getting Started Panel (shown when no configuration is loaded) -->
        <div id="getting-started" class="getting-started">
            <div class="getting-started-buttons">
                <button id="create-standard-config" class="btn-primary getting-started-create-btn" data-mode="standard">
                    <span class="codicon codicon-new-file"></span>
                    <span>New Standard Config</span>
                    <p class="getting-started-btn-description">Migrate specific objects with custom fields and filters</p>
                </button>
                <button id="create-cpq-config" class="btn-primary getting-started-create-btn" data-mode="cpq">
                    <span class="codicon codicon-new-file"></span>
                    <span>New CPQ Config</span>
                    <p class="getting-started-btn-description">Migrate Salesforce CPQ configuration in phases</p>
                </button>
                <button id="create-rca-config" class="btn-primary getting-started-create-btn" data-mode="rca">
                    <span class="codicon codicon-new-file"></span>
                    <span>New RCA Config</span>
                    <p class="getting-started-btn-description">Migrate Revenue Cloud Analytics configuration</p>
                </button>
            </div>
            <div class="getting-started-content">
                <h2>Getting Started with SFDMU Migrations</h2>
                <p class="getting-started-text">
                    Use this extension as a visual front-end for the <strong>SFDX Data Move Utility (SFDMU)</strong> to configure and run data migrations between Salesforce orgs.
                </p>
                <ol class="getting-started-steps">
                    <li><strong>Create a configuration</strong> in the sidebar by adding a folder and configuration file.</li>
                    <li><strong>Select your Source and Target orgs</strong> at the top of the page, or use the edit icons to enter connection details manually.</li>
                    <li><strong>Add migration objects</strong>, choose the DML operation, and optionally define per-object fields and filters.</li>
                    <li><strong>Generate and run</strong> the migration using the action buttons in the header.</li>
                </ol>
                <p class="getting-started-link">
                    For full SFDMU documentation and examples, see
                    <a href="https://help.sfdmu.com/get-started" target="_blank" rel="noopener noreferrer">SFDMU Get Started Guide</a>.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
                <div id="modal-objects-section" style="display: none; margin-top: 16px;">
                    <h4 style="margin-bottom: 8px; font-size: 14px; font-weight: 600;">Objects to be exported:</h4>
                    <div id="modal-objects-list" style="max-height: 400px; overflow-y: auto; background-color: var(--vscode-textCodeBlock-background); padding: 12px; border-radius: 4px; font-family: var(--vscode-editor-font-family); font-size: 12px; word-break: break-word; white-space: pre-wrap;">
                        <!-- Objects will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-cancel" class="btn-secondary">Cancel</button>
                <button id="modal-confirm" class="btn-primary">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Migration Completion Modal -->
    <div id="migration-completion-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="migration-completion-title">Migration Running</h3>
            </div>
            <div class="modal-body">
                <p id="migration-completion-message">The migration is running in the terminal. You can interact with the terminal freely.</p>
                <p style="margin-top: 12px; font-weight: 600;">Has the migration completed successfully?</p>
                <p style="margin-top: 8px; font-size: 12px; color: var(--vscode-descriptionForeground);">
                    Once you confirm, we will create a post-migration backup to capture inserted record IDs for rollback purposes.
                </p>
            </div>
            <div class="modal-footer">
                <button id="migration-completion-skip" class="btn-secondary">Skip Backup</button>
                <button id="migration-completion-confirm" class="btn-primary">Migration Complete</button>
            </div>
        </div>
    </div>
    
    <!-- Excel Export Modal -->
    <div id="excel-export-modal" class="modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h3 id="excel-export-modal-title">Export to Excel</h3>
            </div>
            <div class="modal-body">
                <div id="excel-export-confirm-section">
                    <p id="excel-export-confirm-message">This will execute SOQL queries against your source org and export all data to an Excel file. This may take several minutes depending on the amount of data.</p>
                    <p style="margin-top: 12px; font-weight: 600;">Are you sure you want to proceed?</p>
                </div>
                <div id="excel-export-progress-section" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span id="excel-export-status-text">Preparing export...</span>
                            <span id="excel-export-progress-percent" style="font-weight: 600;">0%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background-color: var(--vscode-progressBar-background); border-radius: 4px; overflow: hidden;">
                            <div id="excel-export-progress-bar" style="width: 0%; height: 100%; background-color: var(--vscode-progressBar-foreground); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div id="excel-export-log" style="max-height: 300px; overflow-y: auto; background-color: var(--vscode-textCodeBlock-background); padding: 12px; border-radius: 4px; font-family: var(--vscode-editor-font-family); font-size: 12px; line-height: 1.5;">
                        <div id="excel-export-log-content"></div>
                    </div>
                </div>
                <div id="excel-export-complete-section" style="display: none;">
                    <p style="color: var(--vscode-testing-iconPassed); margin-bottom: 12px;">✓ Excel file generated successfully!</p>
                    <div id="excel-export-file-link-container" style="margin-top: 16px;">
                        <a id="excel-export-file-link" href="#" style="color: var(--vscode-textLink-foreground); text-decoration: underline; cursor: pointer;">Open Excel file</a>
                    </div>
                </div>
                <div id="excel-export-error-section" style="display: none;">
                    <p style="color: var(--vscode-errorForeground); margin-bottom: 12px;">✗ Export failed</p>
                    <p id="excel-export-error-message" style="font-size: 13px;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="excel-export-cancel" class="btn-secondary">Cancel</button>
                <button id="excel-export-confirm" class="btn-primary">Export</button>
                <button id="excel-export-close" class="btn-primary" style="display: none;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Object Selection Modal -->
    <div id="object-selection-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="object-modal-title">Add Objects</h3>
                <div class="modal-tabs">
                    <button id="tab-select-from-org" class="modal-tab active">Select from Org</button>
                    <button id="tab-manual-entry" class="modal-tab">Manual Entry</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Select from Org Tab -->
                <div id="tab-content-select" class="tab-content active">
                    <div class="object-selection-container">
                        <div class="object-search">
                            <input type="text" id="object-search-input" placeholder="Search objects..." class="text-input">
                            <label class="checkbox-label">
                            </label>
                        </div>
                        <div class="object-list-container">
                            <div id="object-list-loading" class="info-text" style="display: none;">Loading objects...</div>
                            <div id="object-list" class="object-list"></div>
                        </div>
                        <div class="object-selection-summary">
                            <span id="selected-count">0 objects selected</span>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Entry Tab -->
                <div id="tab-content-manual" class="tab-content">
                    <div class="manual-entry-container">
                        <div class="manual-entry-form">
                            <div class="form-group">
                                <label for="manual-object-name">Object Name *</label>
                                <input type="text" id="manual-object-name" class="text-input" placeholder="e.g., Account, CustomObject__c" required>
                            </div>
                            <div class="form-group">
                                <label for="manual-external-id">External ID *</label>
                                <div class="external-id-input-group">
                                    <input type="text" id="manual-external-id" class="text-input" placeholder="e.g., Name, Id, or composite: Field1;Field2" required>
                                    <button id="manual-auto-detect" class="btn-secondary" type="button">Auto-detect</button>
                                </div>
                                <p class="help-text-small">Use semicolon (;) to separate fields for composite external IDs</p>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="manual-use-custom-query">
                                    <span>Use custom SOQL query</span>
                                </label>
                            </div>
                            <div class="form-group" id="manual-soql-group" style="display: none;">
                                <label for="manual-soql-query">SOQL Query</label>
                                <textarea id="manual-soql-query" class="text-input" rows="4" placeholder="SELECT Id, Name FROM ObjectName WHERE ..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="object-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="object-modal-add" class="btn-primary" disabled>Add Object(s)</button>
            </div>
        </div>
    </div>
    
    <!-- Field Selection Modal -->
    <div id="field-selection-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="field-modal-title">Select Fields</h3>
            </div>
            <div class="modal-body">
                <div class="object-selection-container">
                    <div class="object-search">
                        <input type="text" id="field-search-input" placeholder="Search fields..." class="text-input">
                        <label class="checkbox-label">
                            <input type="checkbox" id="select-all-fields">
                            <span>Select All</span>
                        </label>
                    </div>
                    <div class="object-list-container">
                        <div id="field-list-loading" class="info-text" style="display: none;">Loading fields...</div>
                        <div id="field-list" class="object-list"></div>
                    </div>
                    <div class="object-selection-summary">
                        <span id="field-selected-count">0 fields selected</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="field-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="field-modal-clear" class="btn-secondary">Clear (Use All Fields)</button>
                <button id="field-modal-save" class="btn-primary" disabled>Save Selected Fields</button>
            </div>
        </div>
    </div>

    <!-- External ID Selection Modal -->
    <div id="external-id-selection-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="external-id-modal-title">Select External ID for <span id="external-id-modal-object-name"></span></h3>
            </div>
            <div class="modal-body">
                <div class="object-selection-container">
                    <div class="object-search">
                        <input type="text" id="external-id-search-input" placeholder="Search relationship fields..." class="text-input">
                    </div>
                    <div class="object-list-container">
                        <div id="external-id-list-loading" class="info-text" style="display: none;">Loading relationship fields...</div>
                        <div id="external-id-list" class="object-list"></div>
                    </div>
                    <div class="object-selection-summary">
                        <p class="info-text">Select one or more relationship fields to use as external ID. Use semicolon (;) to separate multiple fields for composite keys.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="external-id-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="external-id-modal-save" class="btn-primary" disabled>Use Selected Field(s)</button>
            </div>
        </div>
    </div>
    
    <!-- CPQ Parent Selection Modal -->
    <div id="cpq-master-selection-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Select Records - Phase <span id="master-selection-phase-number"></span></h3>
                <button class="modal-close" id="cpq-master-selection-close">&times;</button>
            </div>
            <div class="master-selection-tabs" id="master-selection-tabs">
                <!-- Tabs for each selectable object (parents or all objects if no parents) -->
            </div>
            <div class="master-selection-content" id="master-selection-content">
                <!-- Tab content with searchable record lists -->
                <div id="master-selection-loading" class="info-text" style="display: none;">Loading records...</div>
            </div>
            <div class="modal-footer">
                <div class="master-selection-summary">
                    <span id="master-selection-count">0 records selected</span>
                </div>
                <div>
                    <button id="master-selection-cancel" class="btn-secondary">Cancel</button>
                    <button id="master-selection-save" class="btn-secondary">Save</button>
                    <button id="master-selection-save-close" class="btn-primary">Save and Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CPQ Children View Modal -->
    <div id="cpq-children-view-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Children for <span id="children-modal-parent-name"></span></h3>
                <button class="modal-close" id="cpq-children-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cpq-children-modal-content">
                    <!-- Children will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="cpq-children-modal-close-btn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Create Folder Modal -->
    <div id="create-folder-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Folder</h3>
            </div>
            <div class="modal-body">
                <label>Folder Name:</label>
                <input type="text" id="folder-name-input" placeholder="Enter folder name" class="text-input">
                <label style="margin-top: 12px;">Parent Folder (optional):</label>
                <select id="parent-folder-select" class="select-input">
                    <option value="">Root</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="create-folder-cancel" class="btn-secondary">Cancel</button>
                <button id="create-folder-confirm" class="btn-primary">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Reparent Configuration Modal -->
    <div id="reparent-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reparent Configuration</h3>
            </div>
            <div class="modal-body">
                <p class="help-text-small">
                    Move configuration <strong id="reparent-config-name"></strong> to a different folder.
                </p>
                <label for="reparent-folder-select" style="margin-top: 8px;">New Parent Folder:</label>
                <select id="reparent-folder-select" class="select-input">
                    <option value="">Root</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="reparent-config-cancel" class="btn-secondary">Cancel</button>
                <button id="reparent-config-confirm" class="btn-primary">Move</button>
            </div>
        </div>
    </div>
    
    <!-- Config Conflict Resolution Modal -->
    <div id="config-conflict-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuration Already Exists</h3>
            </div>
            <div class="modal-body">
                <p id="config-conflict-message"></p>
            </div>
            <div class="modal-footer">
                <button id="config-conflict-cancel" class="btn-secondary">Cancel</button>
                <button id="config-conflict-keep-both" class="btn-secondary">Keep Both</button>
                <button id="config-conflict-replace" class="btn-primary">Replace</button>
            </div>
        </div>
    </div>
    
    <!-- Object Filter Modal -->
    <div id="object-filter-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="object-filter-modal-title">Modify Query</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="object-filter-where">WHERE Clause:</label>
                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                        <div style="flex: 0 0 80%; display: flex; flex-direction: column;">
                            <textarea id="object-filter-where" class="text-input" rows="4" placeholder="e.g., Status = 'Active' AND CreatedDate >= 2024-01-01T00:00:00Z"></textarea>
                            <div id="object-filter-field-pills" style="display: flex; flex-wrap: wrap; gap: 6px; height: 90px; margin-top: 8px; overflow-y: auto; align-content: flex-start;"></div>
                            <p class="help-text-small" id="object-filter-field-loading" style="display: none; margin-top: 4px;">Loading fields...</p>
                            <p class="help-text-small" style="margin-top: 4px;">Enter SOQL WHERE clause conditions (without the WHERE keyword). Multiple conditions can be separated by AND. Field suggestions will appear as you type.</p>
                        </div>
                        <div style="flex: 0 0 20%; display: flex; flex-direction: column; gap: 8px;">
                            <label for="object-filter-data-type" style="font-size: 13px; font-weight: 600; color: var(--vscode-foreground); margin-bottom: 4px;">Insert Sample Value:</label>
                            <select id="object-filter-data-type" class="text-input" style="width: 100%;">
                                <option value="string">String (with quotes)</option>
                                <option value="number">Number</option>
                                <option value="boolean-true">Boolean (true)</option>
                                <option value="boolean-false">Boolean (false)</option>
                                <option value="date">Date</option>
                                <option value="datetime">DateTime</option>
                                <option value="date-today">Date Formula: TODAY</option>
                                <option value="date-yesterday">Date Formula: YESTERDAY</option>
                                <option value="date-tomorrow">Date Formula: TOMORROW</option>
                                <option value="date-last-week">Date Formula: LAST_WEEK</option>
                                <option value="date-this-week">Date Formula: THIS_WEEK</option>
                                <option value="date-next-week">Date Formula: NEXT_WEEK</option>
                                <option value="date-last-month">Date Formula: LAST_MONTH</option>
                                <option value="date-this-month">Date Formula: THIS_MONTH</option>
                                <option value="date-next-month">Date Formula: NEXT_MONTH</option>
                                <option value="date-last-year">Date Formula: LAST_YEAR</option>
                                <option value="date-this-year">Date Formula: THIS_YEAR</option>
                                <option value="date-next-year">Date Formula: NEXT_YEAR</option>
                                <option value="null">Null</option>
                            </select>
                            <button id="object-filter-insert" class="btn-secondary" style="white-space: nowrap; width: 100%;">Insert</button>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px; display: none;">
                    <label for="object-filter-field-search">Insert Field API Name:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <input type="text" id="object-filter-field-search" class="text-input" placeholder="Search fields...">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="object-filter-orderby">ORDER BY Clause:</label>
                    <input type="text" id="object-filter-orderby" class="text-input" placeholder="e.g., CreatedDate DESC, Name ASC"></input>
                    <p class="help-text-small">Enter field names to order by (without the ORDER BY keyword). Use ASC or DESC for direction.</p>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="object-filter-limit">LIMIT Clause:</label>
                    <input type="text" id="object-filter-limit" class="text-input" placeholder="e.g., 100"></input>
                    <p class="help-text-small">Enter a number to limit the number of records returned (without the LIMIT keyword).</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="object-filter-cancel" class="btn-secondary">Cancel</button>
                <button id="object-filter-clear" class="btn-secondary">Clear</button>
                <button id="object-filter-save" class="btn-primary">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Configuration Modal -->
    <div id="configuration-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Configuration</h3>
                <div class="modal-tabs">
                    <button id="config-tab-excluded-objects" class="modal-tab active">Excluded Objects</button>
                    <button id="config-tab-metadata-prerequisites" class="modal-tab rca-mode-only" style="display: none;">Metadata Prerequisites</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Excluded Objects Tab -->
                <div id="config-tab-content-excluded-objects" class="tab-content active">
                    <div class="filter-section">
                        <label>Objects to exclude from migration (one per line):</label>
                        <textarea id="excluded-objects" class="text-input" rows="12" placeholder="Account&#10;Order&#10;OrderItem&#10;Opportunity&#10;Quote"></textarea>
                        <p class="help-text-small">These objects will be excluded from all phases.</p>
                        <p class="help-text-small" id="excluded-objects-cpq-disclaimer" style="display: none; margin-top: 10px; padding: 10px; background-color: var(--vscode-textBlockQuote-background); border-left: 3px solid var(--vscode-textLink-foreground);">
                            <strong>Note:</strong> In CPQ mode, Product2 records are excluded by default. If you wish to include them, please remove Product2 from the list of excluded objects.<br><br>CPQ configuration records in the migration will match to existing Product2 records via <code>ProductCode</code>.
                        </p>
                        <p class="help-text-small" id="excluded-objects-rca-disclaimer" style="display: none; margin-top: 10px; padding: 10px; background-color: var(--vscode-textBlockQuote-background); border-left: 3px solid var(--vscode-textLink-foreground);">
                            <strong>Note:</strong> In RCA mode, Product2 records are excluded by default. If you wish to include them, please remove Product2 from the list of excluded objects.<br><br>RCA configuration records in the migration will match to existing Product2 records via <code>StockKeepingUnit</code> (must be marked as External ID field).
                        </p>
                    </div>
                </div>
                
                <!-- Metadata Prerequisites Tab -->
                <div id="config-tab-content-metadata-prerequisites" class="tab-content">
                    <div class="form-group">
                        <h4>Metadata Prerequisites for Phase 7</h4>
                        <p class="help-text-small">
                            The following metadata objects must be deployed to the target org before running Phase 7:
                        </p>
                        <ul style="margin: 12px 0; padding-left: 24px;">
                            <li><strong>DecisionMatrixDefinition</strong> - External ID: DeveloperName</li>
                            <li><strong>ExpressionSet</strong> - External ID: ApiName</li>
                        </ul>
                        <p class="help-text-small">
                            These metadata objects are referenced by ProductDecompEnrichmentRule in Phase 7 and cannot be migrated via SFDMU (they require Tooling API).
                        </p>
                        <button id="deploy-metadata-from-config" class="btn-secondary" style="margin-top: 12px;">Deploy Metadata Prerequisites</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="configuration-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="configuration-modal-save" class="btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Rollback Confirmation Modal -->
    <div id="rollback-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="rollback-modal-title">Rollback Migration</h2>
                <button id="rollback-modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="rollback-section">
                    <h3>Select Backup to Restore</h3>
                    <div class="form-group">
                        <label for="rollback-backup-select">Backup:</label>
                        <select id="rollback-backup-select" class="select-input" style="width: 100%;">
                            <option value="">Loading backups...</option>
                        </select>
                    </div>
                    <div id="rollback-backup-info" class="backup-info" style="margin-top: 12px; padding: 12px; background: var(--vscode-editor-background); border: 1px solid var(--vscode-panel-border); border-radius: 4px;">
                        <div><strong>Backup Location:</strong> <span id="rollback-backup-path">-</span></div>
                        <div><strong>Date:</strong> <span id="rollback-backup-date">-</span></div>
                        <div><strong>Objects:</strong> <span id="rollback-backup-objects">-</span></div>
                        <div><strong>Records:</strong> <span id="rollback-backup-records">-</span></div>
                    </div>
                </div>

                <div class="rollback-section" style="margin-top: 24px;">
                    <h3>Rollback Summary</h3>
                    <div id="rollback-summary" style="margin-top: 12px;">
                        <p>Select a backup to view rollback details.</p>
                    </div>
                </div>

                <div class="rollback-section" style="margin-top: 24px;">
                    <h3>Operations</h3>
                    <div id="rollback-operations-table" style="margin-top: 12px; overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Object</th>
                                    <th>Original Operation</th>
                                    <th>Rollback Operation</th>
                                    <th>Records</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="rollback-operations-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 24px;">Select a backup to view operations</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="rollback-warnings" class="rollback-section" style="margin-top: 24px; display: none;">
                    <h3 style="color: var(--vscode-errorForeground);">⚠ Warnings</h3>
                    <div id="rollback-warnings-content" style="margin-top: 12px; padding: 12px; background: var(--vscode-inputValidation-errorBackground); border: 1px solid var(--vscode-inputValidation-errorBorder); border-radius: 4px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="rollback-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="rollback-simulation-btn" class="btn-secondary">Run Rollback Simulation</button>
                <button id="rollback-execute-btn" class="btn-primary">Execute Rollback</button>
            </div>
            <div class="modal-footer-note" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--vscode-panel-border); font-size: 12px; color: var(--vscode-descriptionForeground);">
                <p>⚠ This operation cannot be undone. Make sure you want to proceed.</p>
                <p>Consider running simulation first to preview the rollback.</p>
            </div>
        </div>
    </div>
    
    <!-- Load modules in dependency order (explorer.js removed; native Tree View handles configs) -->
    <script src="js/state.js"></script>
    <script src="js/uiUtils.js"></script>
    <script src="js/configManager.js"></script>
    <script src="js/configChangeChecker.js"></script>
    <script src="js/migrationObjects.js"></script>
    <script src="js/migrationExecution.js"></script>
    <script src="js/modals.js"></script>
    <!-- CPQ Mode Modules (load in dependency order) -->
    <script src="js/cpq/constants.js"></script>
    <script src="js/cpq/state.js"></script>
    <script src="js/cpq/masterObjects.js"></script>
    <script src="js/cpq/hierarchicalView.js"></script>
    <script src="js/cpq/masterSelectionModal.js"></script>
    <script src="js/cpq/phases.js"></script>
    <script src="js/cpq/mode.js"></script>
    <script src="js/cpqMode.js"></script>
    <!-- RCA Mode Modules (load in dependency order) -->
    <script src="js/rca/constants.js"></script>
    <script src="js/rca/state.js"></script>
    <script src="js/rcaMasterObjects.js"></script>
    <script src="js/rca/masterSelectionModal.js"></script>
    <script src="js/rca/phases.js"></script>
    <script src="js/rca/metadata.js"></script>
    <script src="js/rca/execution.js"></script>
    <script src="js/rca/mode.js"></script>
    <script src="js/rcaMode.js"></script>
    <script src="js/rollbackManager.js"></script>
    <script src="js/rollbackModal.js"></script>
    <script src="js/messageHandler.js"></script>
    <script src="js/main.js"></script>
    <!-- script.js removed - all functionality moved to modules -->
</body>
</html>

